"use strict";angular.module("propertyManagementApp",["config","ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","firebase","angularPayments","ui.mask","slick","ngFabForm","ngMessages","ngTable","internationalPhoneNumber"]).config(["$routeProvider","$locationProvider","ngFabFormProvider",function(a,b,c){c.extendConfig({validationsTemplate:"views/partials/validationMessages.html"}),b.html5Mode(!0),a.when("/apply/:address",{templateUrl:"views/prescreen.html"}).when("/apply",{templateUrl:"views/prescreen.html"}).otherwise({redirectTo:"/apply"})}]).run(["$window","$rootScope","$location","STRIPE_PUBLISHABLE_KEY",function(a,b,c,d){a.Stripe.setPublishableKey(d),b.$on("$routeChangeSuccess",function(){a.ga("send","pageview",{page:c.path()})}),b.$on("$routeChangeError",function(a,b,d,e){"AUTH_REQUIRED"===e&&c.path("/login")})}]),angular.module("config",[]).constant("ENV","develop").constant("FIREBASE_URL","https://castle-development.firebaseio.com").constant("STRIPE_PUBLISHABLE_KEY","pk_test_ezgQYWkPV0W4Npb6E5LpMngz").constant("AMAZON_S3_PUBLIC_ACCESS_KEY","AKIAJDRTBGRFWMSEWWEQ").constant("AMAZON_S3_PUBLIC_SECRET_KEY","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").constant("AMAZON_S3_PUBLIC_BUCKET","uploads.entercastle.com"),angular.module("propertyManagementApp").factory("Auth",["$firebase","$firebaseAuth","FIREBASE_URL","$window","$location","$q",function(a,b,c,d,e,f){var g=new d.Firebase(c),h={},i=null,j={registerUser:function(a){var b=f.defer();return g.createUser({email:a.email,password:a.password},function(a,c){a&&b.reject(j.translateError(a)),b.resolve(c)}),b.promise},loginUser:function(a){var b=f.defer();return g.authWithPassword(a,function(a){a&&b.reject(j.translateError(a)),b.resolve(i),i=null}),b.promise},logoutCurrentUser:function(){g.unauth(),e.path("/login")},getCurrentUser:function(){return j.isUserAuthenticated()||(i=e.path(),e.path("/login")),h},isUserAuthenticated:function(){return!!h.uid},isUserAdmin:function(){var b=f.defer();return a(g.child("admins").child(h.uid)).$asObject().$loaded().then(function(a){b.resolve(a.$value)}),b.promise.then(function(a){return!!a})},isUserTenant:function(){var b=f.defer();return a(g.child("indexes").child("roles").child("tenants").child(h.uid)).$asObject().$loaded().then(function(a){null===a.$value?b.reject():b.resolve(a.$value)}),b.promise},updateProfile:function(b){var c=a(g.child("profile"));return c.$set(j.getCurrentUser().uid,b)},getRedirect:function(){return i},translateError:function(a){return"INVALID_EMAIL"===a.code?"Invalid email. Please check that you have entered a valid email address":"INVALID_PASSWORD"===a.code?"Looks like that password is incorrect. Need help? Contact us at support@entercastle.com or (313) 214-2663":"EMAIL_TAKEN"===a.code?"That email is already associated with a Castle account. Please use another email address or contact us at (313) 214-2663 for help.":"INVALID_USER"===a.code?"Hmm... we can't find that email in our system":a},require:function(){return b(g).$requireAuth()},resetPassword:function(a,b,c){var d=f.defer();return g.changePassword({email:a,oldPassword:b,newPassword:c},function(a){a?d.reject(j.translateError(a)):d.resolve()}),d.promise},sendPasswordResetEmail:function(a){var b=f.defer();return g.resetPassword({email:a},function(a){a?b.reject(j.translateError(a)):b.resolve()}),b.promise}};return g.onAuth(function(b){b?(angular.copy(b,h),h.profile=a(g.child("profile").child(h.uid)).$asObject()):(h&&h.profile&&h.profile.$destroy(),angular.copy({},h))}),j}]),angular.module("propertyManagementApp").factory("Bank",["$location","$window","$q","Auth","BackgroundJob",function(a,b,c,d,e){var f={storeCreditCardToken:function(a,b){var e=c.defer();if(b.error)e.reject(b.error.message);else{var f=d.getCurrentUser();f.profile.creditCardToken=b.id,e.resolve(f.profile.$save())}return e.promise},storeBankAccountToken:function(a){var b=d.getCurrentUser();return b.profile.bankAccountToken=a,b.profile.$save()},tokenizeBankAccount:function(a){var d=c.defer();if(a.holderName&&a.routingNumber&&a.accountNumber){var e={name:a.holderName,account_number:a.accountNumber,routing_number:a.routingNumber,account_type:"checking"};b.balanced.bankAccount.create(e,function(a){if(a.errors){for(var b=[],c=0;c<a.errors.length;c++)b.push(a.errors[c].description);return d.reject(b)}var e=a.bank_accounts[0].href;return d.resolve(e)})}else d.reject(["Bank accounts require name, routing number, and account number"]);return d.promise},credit:function(a,b){return e.create({jobType:"creditBankAccount",bankAccountId:a,amount:b})},debit:function(a,b){return e.create({jobType:"debitBankAccount",bankAccountId:a,amount:b})}};return f}]),angular.module("propertyManagementApp").factory("Sidebar",function(){var a={collapsed:!0},b=function(b){a.collapsed||b.preventDefault()};return document.addEventListener("touchmove",b,!0),{toggle:function(){a.collapsed=!a.collapsed},getData:function(){return a}}}),angular.module("propertyManagementApp").factory("Property",["$firebase","FIREBASE_URL","$window","$q","Auth","Tenant",function(a,b,c,d,e,f){var g=new c.Firebase(b),h={},i={getAll:function(){var b=d.defer(),c=[];return a(g.child("profile")).$asArray().$loaded().then(function(d){var e=0;d.forEach(function(f){a(g.child("properties").child(f.$id)).$asArray().$loaded().then(function(a){a.forEach(function(a){a.owner=f.firstName+" "+f.lastName}),c=c.concat(a),e+=1,e===d.length&&b.resolve(c)})})})["catch"](b.reject),b.promise},getUsersProperties:function(b){var c=d.defer();return a(g.child("properties").child(b)).$asArray().$loaded().then(function(a){c.resolve(a)})["catch"](function(a){c.reject(a)}),c.promise},getCurrentUserProperties:function(){var b=d.defer();return e.isUserAdmin().then(function(c){c?b.resolve(i.getAll()):a(g.child("properties").child(e.getCurrentUser().uid)).$asArray().$loaded().then(function(a){b.resolve(a)})["catch"](function(a){b.reject(a)})}),b.promise},getPropertyData:function(a){var b=d.defer();return g.child("indexes").child("properties").child(a).once("value",function(c){g.child("properties").child(c.val().uid).child(a).once("value",function(a){b.resolve(a.val())},b.reject)}),b.promise},getTenants:function(b){var c=a(g.child("tenants").child(b)).$asArray().$loaded().then(function(b){var c=d.defer();return a(g.child(".info/serverTimeOffset")).$asObject().$loaded().then(function(a){for(var d=a.$value,e=0;e<b.length;e++)b[e].moveInDate+=d;c.resolve(b)}),c.promise});return c},getNewProperty:function(){return h},saveNewProperty:function(){var b=d.defer();return g.child(".info/serverTimeOffset").once("value",function(c){var i=c.val();h.agreement.timestamp=(new Date).getTime()+i;var j=e.getCurrentUser().uid,k=a(g.child("properties").child(j));h.lease&&h.lease.url&&(h.documents=[],h.documents.push({name:"Uploaded Lease",url:h.lease.url}));var l=h.newTenants;delete h.newTenants,k.$asArray().$add(h).then(function(a){var b=a.key(),c=[];return l.forEach(function(a){""===a.phoneNumber&&delete a.phoneNumber,delete a.$$hashKey,c.push(f.saveNewTenant(b,a))}),d.all(c)}).then(function(){h={},b.resolve()})}),b.promise},update:function(a,b){var c=d.defer(),e=a.id;return a.documents&&a.documents.forEach(function(a){delete a.$$hashKey}),g.child("indexes").child("properties").child(e).once("value",function(d){g.child("properties").child(d.val().uid).child(e).update(a,function(a){a&&c.reject(a),b.length||c.resolve();var d=0;b.forEach(function(a){delete a.$$hashKey,isNaN(a.moveInDate)&&delete a.moveInDate,a.$id?b.$save(a).then(function(){d++,d===b.length&&c.resolve()}):f.saveNewTenant(e,a).then(function(){var e=b.indexOf(a);-1!==e&&"function"==typeof b.$save&&b.splice(e,1),d++,d===b.length&&c.resolve()})})})}),c.promise},getOwnerInfo:function(a){var b=d.defer();return g.child("indexes").child("properties").child(a).once("value",function(a){g.child("profile").child(a.val().uid).once("value",function(a){var c=a.val();b.resolve({id:a.key(),email:c.email,name:c.firstName,fullName:c.firstName+" "+c.lastName,phoneNumber:c.phoneNumber,bankAccountId:c.balancedBankAccountId,isBankAccountLinked:!(!c.bankAccountToken&&!c.balancedBankAccountId),isCreditCardLinked:!(!c.creditCardToken&&!c.stripeCustomerId)})},b.reject)},b.reject),b.promise},getTypes:function(){return["Single-family home","Duplex","Triplex","Condo","Other"]},getOwnershipDurations:function(){return["Just acquired","Less than 1 year","1-5 years","More than 5 years"]},getAvailableRentStatuses:function(){return["invited","linked","paid","late"]}};return i}]),angular.module("propertyManagementApp").factory("Tenant",["$firebase","FIREBASE_URL","$window","$location","$q","Bank","Auth",function(a,b,c,d,e,f,g){var h=new c.Firebase(b),i={getAuthenticatedTenant:function(){var b=e.defer(),c=g.getCurrentUser();return a(h.child("indexes").child("roles").child("tenants").child(c.uid)).$asObject().$loaded().then(function(c){a(h.child("tenants").child(c.propertyId).child(c.id)).$asObject().$loaded().then(function(a){b.resolve(a)},function(a){b.reject(a)})},function(a){b.reject(a)}),b.promise},requireBankAccount:function(){var b=e.defer(),c=g.getCurrentUser();return a(h.child("indexes").child("roles").child("tenants").child(c.uid)).$asObject().$loaded().then(function(c){a(h.child("tenants").child(c.propertyId).child(c.id)).$asObject().$loaded().then(function(a){a.bankAccountToken||a.balancedBankAccountId?b.resolve():d.path("/tenants/"+a.$id)},function(a){b.reject(a)})},function(a){b.reject(a)}),b.promise},getById:function(b){var c=e.defer(),d=a(h.child("tenants")).$asArray();return d.$loaded().then(function(a){for(var d=0;d<a.length;d++)if(a[d][b]){var e=a[d][b];e.propertyId=a[d].$id,e.id=b,c.resolve(e)}c.reject("Tenant not found")}),c.promise},getProperty:function(b){var c=e.defer();return a(h.child("indexes").child("properties").child(b.propertyId)).$asObject().$loaded().then(function(b){a(h.child("properties").child(b.uid).child(b.$id)).$asObject().$loaded().then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise},update:function(a){var b=e.defer(),c=a.id,d=a.propertyId,f={};return angular.copy(a,f),c&&d?(delete f.id,delete f.propertyId,delete f.password,h.child("tenants").child(d).child(c).update(f,function(c){c?b.reject(c):b.resolve(a)})):b.reject("There was an error updating your information. Please refresh the page and try again"),b.promise},updatePhoneNumber:function(a){var b=e.defer();return a.id&&a.propertyId?h.child("tenants").child(a.propertyId).child(a.id).child("phoneNumber").set(a.phoneNumber,function(a){a?b.reject(a):b.resolve()}):b.reject("There was an error while trying to save the tenant (property and tenant IDs required)"),b.promise},linkBankAccount:function(a,b){return f.tokenizeBankAccount(b).then(function(b){var c=e.defer();return a.id&&a.propertyId&&h.child("tenants").child(a.propertyId).child(a.id).child("bankAccountToken").set(b,function(a){a?c.reject(a):c.resolve()}),c.promise})},saveInherited:function(b,c){return a(h.child("tenants").child("inherited").child(c)).$push(b)},saveNewTenant:function(b,c){return c.rent&&!c.rent.label&&(c.rent.label="Unlinked"),a(h.child("tenants").child(b)).$push(c)},createUser:function(a){var b,c=e.defer();return g.registerUser(a).then(function(c){return b=c.uid,g.loginUser(a)},function(a){c.reject(a)}).then(function(){return b?h.child("indexes").child("roles").child("tenants").child(b).set({id:a.id,propertyId:a.propertyId},function(a){return a?c.reject(a):void 0}):void 0},function(a){c.reject(a)}).then(function(){b&&h.child(".info/serverTimeOffset").once("value",function(d){var e=d.val();h.child("tenants").child(a.propertyId).child(a.id).child("accountCreatedAt").set((new Date).getTime()+e,function(a){return a?c.reject(a):c.resolve(b)})})}),c.promise},getAccountCreatedDate:function(b){var c=e.defer();return a(h.child(".info/serverTimeOffset")).$asObject().$loaded().then(function(a){var d=a.$value;c.resolve(b.accountCreatedAt+d)}),c.promise},makeRentPayment:function(a,b,c,d){var f=e.defer(),g=h.child("tenants").child(a.propertyId).child(a.$id);return g.child("rent").child("payments").push({createdAt:(new Date).getTime(),amount:b,dueDate:c.getTime(),createdBy:d||"tenant"},function(a){a&&f.reject(a),g.child("rent").update({label:"paid",status:"paid"},function(a){a&&f.reject(a),f.resolve()})}),f.promise},getRentPayments:function(b){return a(h.child("tenants").child(b.propertyId).child(b.$id).child("rent").child("payments")).$asArray()},getNextRentPayment:function(a,b){var c=e.defer();return i.getAccountCreatedDate(a).then(function(d){var e=new Date(d),f=new Date(e.getFullYear(),e.getMonth()+1+b.length,1);c.resolve({dueDate:f,amount:a.rent.share})}),c.promise}};return i}]),angular.module("propertyManagementApp").factory("Flash",["$rootScope",function(a){var b=[];return{setMessage:function(a){b.push(a)},getMessage:function(){return b.shift()||""},setMessageWithoutReload:function(b){a.$broadcast("flash",b)}}}]),angular.module("propertyManagementApp").factory("Uploader",["$window","$q","AMAZON_S3_PUBLIC_BUCKET","AMAZON_S3_PUBLIC_ACCESS_KEY","AMAZON_S3_PUBLIC_SECRET_KEY",function(a,b,c,d,e){var f=a.AWS,g=c,h={accessKeyId:d,secretAccessKey:e};f.config.update(h),f.config.region="us-east-1";var i=new f.S3({params:{Bucket:g}}),j={saveFile:function(a){var c=b.defer();if(a&&a.name&&a.type){var d={Key:(new Date).getTime()+"-"+a.name,ContentType:a.type,Body:a,ServerSideEncryption:"AES256"};i.putObject(d,function(a){a?c.reject(a.message):c.resolve({bucket:g,name:d.Key,url:"https://s3.amazonaws.com/"+g+"/"+d.Key})}).on("httpUploadProgress",function(a){c.notify(a.loaded/a.total*100)})}else c.reject("File with name and type required for upload");return c.promise}};return j}]),angular.module("propertyManagementApp").factory("Geography",function(){return{getAvailableStates:function(){return["MI"]}}}),angular.module("propertyManagementApp").factory("BackgroundJob",["$firebase","$window","FIREBASE_URL",function(a,b,c){var d=new b.Firebase(c);return{create:function(b){return a(d.child("backgroundJobs")).$asArray().$add(b)}}}]),angular.module("propertyManagementApp").directive("creditCardForm",["Auth","Bank","Property","Flash","$location",function(a,b,c,d,e){return{restrict:"E",templateUrl:"views/partials/creditCardForm.html",link:function(f){f.cardholder={};var g=!1;a.getCurrentUser().profile.$loaded().then(function(a){f.cardholder.fullName=a.firstName+" "+a.lastName,g=a.bankAccountToken||a.balancedBankAccountId}),f.$watch("expiryMonth",function(a){f.expiry=a+"/"+f.expiryYear}),f.$watch("expiryYear",function(a){f.expiry=f.expiryMonth+"/"+a}),f.callback=function(a,h){f.errors=[],b.storeCreditCardToken(a,h).then(function(){return c.getCurrentUserProperties()},function(a){f.errors.push(a)}).then(function(){g?(d.setMessage("Your payment information has been linked successfully."),e.path("/properties")):e.path("/bank-account")})}}}}]),angular.module("propertyManagementApp").directive("bankAccountForm",["Bank","$location","Auth","Flash",function(a,b,c,d){return{restrict:"E",templateUrl:"views/partials/bankAccountForm.html",link:function(e){c.getCurrentUser(),e.bankAccount={},e.submit=function(){a.tokenizeBankAccount(e.bankAccount).then(function(b){return a.storeBankAccountToken(b)}).then(function(){d.setMessage("Your payment information has been linked successfully.")}).then(function(){b.path("/properties")})["catch"](function(a){e.errors=a})}}}}]),angular.module("propertyManagementApp").directive("tenantBankAccountForm",["$routeParams","$window","$location","Tenant","Flash",function(a,b,c,d,e){return{restrict:"E",templateUrl:"views/partials/tenantBankAccountForm.html",link:function(f){f.bankAccount={},f.$watch("bankAccount.accountNumber",function(a){f.confirmationMatches=a&&a===f.bankAccount.confirmAccountNumber}),f.$watch("bankAccount.confirmAccountNumber",function(a){f.confirmationMatches=a&&a===f.bankAccount.accountNumber}),d.getById(a.tenantId).then(function(a){f.tenant=a,f.bankAccount.holderName=a.firstName+" "+a.lastName})["catch"](function(){b.alert("There was an error looking up your record in the system. Please contact us at (313) 214-2663."),b.location.href="http://entercastle.com/contact/"}),f.submit=function(){f.errors=[];var a=f.tenant,b=f.bankAccount;f.confirmationMatches?d.updatePhoneNumber(a).then(function(){return d.linkBankAccount(a,b)}).then(function(){e.setMessage("<h3>You’re almost done!</h3><p>In the next few days, we’ll make two small deposits into your bank account. You’ll need to confirm the amounts of those deposits in order to verify your payment information.</p><p>We’ll text you at <strong>("+a.phoneNumber.substring(0,3)+") "+a.phoneNumber.substring(3,6)+"-"+a.phoneNumber.substring(6)+"</strong> once we’ve made the deposits. Respond to the text and you’ll be good to go!"),c.path("/tenants/dashboard")})["catch"](function(a){f.errors.push(a)}):f.errors.push("Your bank account confirmation doesn't match!")}}}}]),angular.module("propertyManagementApp").directive("signupForm",["Auth","$location",function(a,b){return{restrict:"E",templateUrl:"views/partials/signupForm.html",link:function(c){c.newUser={password:""},c.$watch("signup.password.$error.pattern",function(a){c.passwordContainsNumber=void 0===a&&!c.signup.password.$error.required}),c.$watch("signup.password.$error.minlength",function(a){c.passwordIsLongEnough=void 0===a&&!c.signup.password.$error.required}),c.submit=function(){c.errors=[],a.registerUser(c.newUser).then(function(){return a.loginUser(c.newUser)}).then(function(){return a.updateProfile({firstName:c.newUser.firstName,lastName:c.newUser.lastName,email:c.newUser.email,phoneNumber:c.newUser.phoneNumber})}).then(function(){b.path("/")})["catch"](function(a){c.errors.push(a)})}}}}]),angular.module("propertyManagementApp").directive("loginForm",["Auth","$location",function(a,b){return{restrict:"E",templateUrl:"views/partials/loginForm.html",link:function(c){c.redirect=a.getRedirect(),a.isUserAuthenticated()&&a.isUserTenant().then(function(){b.path("/tenants/dashboard")},function(){b.path("/properties")}),c.submit=function(d){c.errors=[],a.loginUser(d).then(function(c){c?b.path(c):a.isUserTenant().then(function(){b.path("/tenants/dashboard")},function(){b.path("/properties")})})["catch"](function(a){c.errors.push(a)})}}}}]),angular.module("propertyManagementApp").directive("currentUserName",["Auth",function(a){return{restrict:"E",template:"{{ profile.firstName }}",link:function(b){a.getCurrentUser().profile.$loaded().then(function(a){b.profile=a})}}}]),angular.module("propertyManagementApp").directive("prescreenForm",["$routeParams","$window","$firebase","FIREBASE_URL","$anchorScroll",function(a,b,c,d,e){return{restrict:"E",templateUrl:"views/partials/prescreenForm.html",link:function(f){var g=new b.Firebase(d);if(a.address){var h=a.address,i=h.replace(/_/g," ");f.address=i}f.submit=function(){var a=c(g.child("applications").child(f.address)).$asArray();a.$add(f.applicant).then(function(){f.successfulSubmit=!0,e()})}}}}]),angular.module("propertyManagementApp").directive("inheritedForm",["$routeParams","$anchorScroll","Tenant",function(a,b,c){return{restrict:"E",templateUrl:"views/partials/inheritedForm.html",link:function(d){if(a.address){var e=a.address,f=e.replace(/_/g," ");d.address=f}d.submit=function(){d.errors=[],d.tenant.onLease&&!d.tenant.leaseUrl?d.errors.push("We need a copy of your current lease to continue"):c.saveInherited(d.tenant,d.address).then(function(){d.successfulSubmit=!0,b()})}}}}]),angular.module("propertyManagementApp").directive("footerWrapper",function(){return{restrict:"E",templateUrl:"views/partials/footerWrapper.html",transclude:!0}}),angular.module("propertyManagementApp").directive("sidebar",["Sidebar","Auth","$location",function(a,b,c){return{restrict:"A",templateUrl:"views/partials/sidebar.html",link:function(d,e){d.sidebar={data:a.getData()},d.path=c.path(),d.collapseSidebar=a.toggle;var f=d.$watch("sidebar.data.collapsed",function(a){a?e.removeClass("sidebar-open"):e.addClass("sidebar-open")});d.$on("$destroy",function(){f()}),b.isUserTenant().then(function(){d.isTenant=!0},function(){d.isTenant=!1})}}}]).directive("content",["Sidebar",function(a){return{link:function(b,c){b.sidebar={data:a.getData()};var d=b.$watch("sidebar.data.collapsed",function(a){a?c.removeClass("sidebar-open"):c.addClass("sidebar-open")});b.$on("$destroy",function(){d()})}}}]).directive("sidebarToggle",["Sidebar",function(a){return{template:'<a id="menu-toggle" ng-click="toggle()"><i class="fa fa-bars"></i></a>',link:function(b){b.toggle=a.toggle}}}]),angular.module("propertyManagementApp").directive("mobileHeader",function(){return{restrict:"E",template:'<div id="mobile-header"> <div sidebar-toggle></div> <span ng-transclude></span> </div>',transclude:!0}}),angular.module("propertyManagementApp").directive("propertiesList",["Property","ngTableParams","$filter","$location",function(a,b,c,d){return{scope:{properties:"=",hideOwners:"@"},restrict:"E",templateUrl:"views/partials/propertiesList.html",link:function(a){a.isOnboarding=d.search().onboarding,a.$watch("properties",function(d){d&&d.length&&(a.tableParams=new b({page:1,count:a.properties.length,sorting:{street:"asc"}},{counts:[],total:a.properties.length,getData:function(b,d){var e=d.sorting()?c("orderBy")(a.properties,d.orderBy()):a.properties;b.resolve(e.slice((d.page()-1)*d.count(),d.page()*d.count()))}}))})}}}]),angular.module("propertyManagementApp").directive("propertyData",["$routeParams","$anchorScroll","$timeout","Property",function(a,b,c,d){return{restrict:"E",templateUrl:"views/partials/propertyData.html",link:function(e){e.mode="preview",e.setMode=function(a){e.mode=a};var f=a.propertyId;e.$watch("property.images",function(){e.property&&e.property.images&&(e.reloadSlider=!e.reloadSlider)},!0),d.getPropertyData(f).then(function(b){return e.property=b,e.property.id=f,d.getTenants(a.propertyId)}).then(function(a){e.tenants=a}).then(function(){c(b)})}}}]),angular.module("propertyManagementApp").directive("propertyOwnerData",["$routeParams","Property","Bank",function(a,b,c){return{scope:!0,restrict:"E",templateUrl:"views/partials/propertyOwnerData.html",link:function(d){var e=a.propertyId;d.message="",b.getOwnerInfo(e).then(function(a){return d.owner=a,b.getUsersProperties(a.id)}).then(function(a){d.properties=a}),d.creditBankAccount=function(a,b){c.credit(a,b).then(function(){d.message="Credit has been created."})},d.acknowledge=function(){d.message=""}}}}]),angular.module("propertyManagementApp").directive("numeric",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){var b=a,c=a.replace(/[^0-9]/g,"");return c!==b&&(d.$setViewValue(b),d.$render()),c}d.$parsers.push(e)}}}),angular.module("propertyManagementApp").directive("errors",function(){return{restrict:"E",templateUrl:"views/partials/errors.html"}}),angular.module("propertyManagementApp").directive("notice",function(){return{restrict:"E",templateUrl:"views/partials/notice.html",scope:{text:"@",nextStep:"@",linksTo:"@"}}}),angular.module("propertyManagementApp").directive("noticeBankAccount",["Auth",function(a){return{restrict:"E",templateUrl:"views/partials/notice.html",scope:{},link:function(b,c){b.text="Before we can issue payouts to you, you’ll need to link your bank account.",b.nextStep="Link your bank account now →",b.linksTo="#/bankAccount",a.getCurrentUser().profile.$loaded().then(function(a){a.bankAccountToken||a.balancedBankAccountId||!a.creditCardToken&&!a.stripeCustomerId?c.find(".error").addClass("hidden"):c.find(".hidden").removeClass("hidden")})}}}]),angular.module("propertyManagementApp").directive("noticeCreditCard",["Auth",function(a){return{restrict:"E",templateUrl:"views/partials/notice.html",scope:{},link:function(b,c){b.text="It looks like we’re missing your payment information. You’ll need to submit that information before you can receive payouts from Castle.",b.nextStep="Submit your payment information →",b.linksTo="#/credit-card",a.getCurrentUser().profile.$loaded().then(function(a){a.creditCardToken||a.stripeCustomerId?c.find(".error").addClass("hidden"):c.find(".hidden").removeClass("hidden")})}}}]),angular.module("propertyManagementApp").directive("flashMessage",["Flash",function(a){return{restrict:"E",templateUrl:"views/partials/flashMessage.html",link:function(b){b.message=a.getMessage(),b.dismiss=function(){delete b.message},b.$on("flash",function(a,c){b.message=c})}}}]),angular.module("propertyManagementApp").directive("fileInput",["Uploader",function(a){return{restrict:"E",templateUrl:"views/partials/fileInput.html",scope:{output:"=for"},link:function(b,c){c.find("input").bind("change",function(c){var d=c.target.files,e=d[0];b.file=e,b.progress=0,b.file.uploaded=!1,a.saveFile(b.file).then(function(a){b.file.uploaded=!0,a.name=b.file.name,b.output=a},function(a){a&&b.errors.push("There was an error uploading your file, sorry about that! Please try again")},function(a){b.progress=a}),b.$apply()})}}}]),angular.module("propertyManagementApp").directive("multiStep",function(){return{restrict:"E",templateUrl:"views/partials/multiStep.html",scope:{steps:"=",current:"=",next:"="},link:function(a){a.current=a.steps[0],a.getStatus=function(b){return a.steps.indexOf(b)===a.steps.indexOf(a.current)?"in-progress":a.steps.indexOf(b)<a.steps.indexOf(a.current)?"complete":""},a.next=function(){a.current=a.steps[a.steps.indexOf(a.current)+1]}}}}),angular.module("propertyManagementApp").directive("olark",function(){return{restrict:"E",templateUrl:"views/partials/olark.html",scope:{showHelp:"=help"}}}),angular.module("propertyManagementApp").directive("addPropertyForm",["$location","$anchorScroll","Property","Geography","Flash","Auth",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"views/partials/addPropertyForm.html",link:function(g){var h=a.search().onboarding;g.availableStates=d.getAvailableStates(),g.propertyTypes=c.getTypes(),g.ownershipDurations=c.getOwnershipDurations(),g.keysHeldByOwnerOptions=[{label:"Me",value:!0},{label:"Someone else",value:!1}],g.newProperty=c.getNewProperty(),g.newProperty.newTenants=[{}],g.newProperty.stateAbbreviation="MI",g.user=f.getCurrentUser(),g.addTenant=function(){g.newProperty.newTenants.push({})},g.deleteTenant=function(a){g.newProperty.newTenants.splice(a,1)},g.submit=function(){g.currentStep===g.addPropertySteps[g.addPropertySteps.length-1]?c.saveNewProperty().then(function(){h||e.setMessage("Your property has been added. A member of the Castle Team will be in touch soon to talk next steps!")}).then(function(){h?a.path("/properties").search({onboarding:!0}):a.path("/properties")}):(g.nextStep(),b())}}}}]),angular.module("propertyManagementApp").directive("editPropertyForm",["Geography","Property","BackgroundJob","Bank","$route","$timeout",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"views/partials/editPropertyForm.html",link:function(g){g.message="",g.availableStates=a.getAvailableStates(),g.rentStatuses=b.getAvailableRentStatuses(),g.addIssue=function(){g.property.issues||(g.property.issues=[]),g.property.issues.push("")},g.addAlert=function(){g.property.additionalInfo||(g.property.additionalInfo=[]),g.property.additionalInfo.push("")},g.addTenant=function(){g.tenants&&g.tenants.length||(g.tenants=[]),g.tenants.push({})},g.deleteIssue=function(a){g.property.issues.splice(a,1)},g.deleteAlert=function(a){g.property.additionalInfo.splice(a,1)},g.deleteDocument=function(a){g.property.documents.splice(a,1)},g.deleteImage=function(a){g.property.images.splice(a,1)},g.sendNotificationEmail=function(a,d){b.getOwnerInfo(g.property.id).then(function(b){return c.create({jobType:"notificationEmail",template:a,email:b.email,name:b.name,address:g.property.street,callToActionPath:d})}).then(function(){g.notificationSent=!0,f(function(){g.notificationSent=!1},3e3)})},g.debitBankAccount=function(a,b){d.debit(a,b).then(function(){g.message="Debit has been created."})},g.acknowledge=function(){g.message=""},g.submit=function(){b.update(g.property,g.tenants).then(function(){e.reload()})},g.$watch("newDoc",function(){g.newDoc&&g.newDoc.name&&g.newDoc.url&&(g.property.documents||(g.property.documents=[]),g.property.documents.push(g.newDoc),g.newDoc={})}),g.$watch("newImage",function(){g.newImage&&g.newImage.url&&(g.property.images||(g.property.images=[]),g.property.images.push(g.newImage.url),g.newImage={})}),g.$watch("newThumbnail",function(){g.newThumbnail&&g.newThumbnail.url&&(g.property.thumbnail=g.newThumbnail.url,g.newThumbnail={})})}}}]),angular.module("propertyManagementApp").directive("searchBox",function(){return{restrict:"E",templateUrl:"views/partials/searchBox.html",scope:{query:"="}}}),angular.module("propertyManagementApp").directive("managementAgreement",function(){return{restrict:"E",templateUrl:"views/partials/managementAgreement.html"}}),angular.module("propertyManagementApp").directive("adminOnly",["Auth",function(a){return{restrict:"E",template:'<div ng-show="isAdmin === true" ng-transclude></div>',transclude:!0,link:function(b){a.isUserAdmin().then(function(a){b.isAdmin=a})}}}]),angular.module("propertyManagementApp").directive("ownerOnly",["Auth",function(a){return{restrict:"E",template:'<div ng-show="isAdmin === false" ng-transclude></div>',transclude:!0,link:function(b){a.isUserAdmin().then(function(a){b.isAdmin=a})}}}]),angular.module("propertyManagementApp").filter("percentage",["$window",function(a){return function(b,c,d){return c=angular.isNumber(c)?c:0,d=d||"%",a.isNaN(b)?"":Math.round(b*Math.pow(10,c+2))/Math.pow(10,c)+d}}]),angular.module("propertyManagementApp").filter("propertyImageUrl",function(){return function(a,b,c){return a&&a.thumbnail?a.thumbnail:a?"https://maps.googleapis.com/maps/api/streetview?location="+a.street+" "+a.city+" "+a.stateAbbreviation+"&size="+b+"x"+c:void 0}}),angular.module("propertyManagementApp").controller("PasswordResetController",["$routeParams","$location","$scope","Auth",function(a,b,c,d){function e(){f.passwordsMatch=f.confirm&&f.confirm===f.newPassword,f.form&&f.form.confirm.$setValidity("matches",f.passwordsMatch)}var f=this;f.email=a.email,f.token=a.token,f.newPassword="",c.$watch(function(){return f.form&&f.form.password.$error.pattern},function(a){f.passwordContainsNumber=void 0===a&&f.form&&!f.form.password.$error.required}),c.$watch(function(){return f.form&&f.form.password.$error.minlength},function(a){f.passwordIsLongEnough=void 0===a&&f.form&&!f.form.password.$error.required}),c.$watch(function(){return f.newPassword},function(){e()}),c.$watch(function(){return f.confirm},function(){e()}),this.submit=function(){f.errors=[];var a={email:f.email,password:f.newPassword};d.resetPassword(f.email,f.token,f.newPassword).then(function(){return d.loginUser(a)}).then(function(a){b.path(a)})["catch"](function(a){f.errors.push(a)})}}]),angular.module("propertyManagementApp").controller("PasswordResetEmailController",["Auth",function(a){var b=this;console.log("PasswordResetEmailController loaded"),this.sendEmail=function(){console.log("Sending password reset email"),b.errors=[],a.sendPasswordResetEmail(b.email).then(function(){b.emailSent=!0})["catch"](function(a){b.errors.push(a)})}}]),angular.module("propertyManagementApp").controller("PropertiesController",["Property",function(a){var b=this;a.getCurrentUserProperties().then(function(a){b.properties=a})}]),angular.module("propertyManagementApp").controller("TenantSignupController",["$routeParams","$scope","$location","Tenant",function(a,b,c,d){var e=this,f=a.tenantId;d.getById(f).then(function(a){a.uid&&c.path("/login"),e.tenant=a,e.tenant.password=""}),e.passwordContainsNumber=!1,e.passwordIsLongEnough=!1,e.submit=function(){e.errors=[],d.createUser(e.tenant).then(function(a){return e.tenant.uid=a,d.update(e.tenant)}).then(function(){c.path("/tenants/dashboard")})["catch"](function(a){e.errors.push(a)})},b.$watch(function(){return e.form&&e.form.password.$error.pattern},function(a){e.passwordContainsNumber=void 0===a&&e.form&&!e.form.password.$error.required}),b.$watch(function(){
return e.form&&e.form.password.$error.minlength},function(a){e.passwordIsLongEnough=void 0===a&&e.form&&!e.form.password.$error.required})}]),angular.module("propertyManagementApp").controller("TenantDashboardController",["$location","Tenant","Flash",function(a,b,c){function d(){b.getNextRentPayment(e.tenant,e.rentPayments).then(function(a){e.nextRentPayment=a}),e.lastRentPayment=e.rentPayments[e.rentPayments.length-1]}{var e=this;new Date}e.payRent=function(){b.makeRentPayment(e.tenant,e.nextRentPayment.amount,e.nextRentPayment.dueDate).then(function(){c.setMessageWithoutReload("<h3>Thanks!</h3><p>Your payment has been made successfully.</p>")})},b.getAuthenticatedTenant().then(function(c){return e.tenant=c,c.bankAccountToken||c.balancedBankAccountId||a.path("/tenants/"+c.$id),b.getProperty(c)}).then(function(a){e.property=a,e.rentPayments=b.getRentPayments(e.tenant),e.rentPayments.$loaded().then(d),e.rentPayments.$watch(d)})}]);